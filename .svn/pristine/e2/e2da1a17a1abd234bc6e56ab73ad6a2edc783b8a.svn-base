<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
  <head>    
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>    
    <title>Calendar Details</title>    
    <link href="/owner-web/css/main.css" rel="stylesheet" type="text/css" />       
    <link href="/owner-web/css/dp.css" rel="stylesheet" />    
    <link href="/owner-web/css/dropdown.css" rel="stylesheet" />    
    <link href="/owner-web/css/colorselect.css" rel="stylesheet" />   
     
    <script src="/owner-web/js/jquery.js" type="text/javascript"></script>    
    <script src="/owner-web/js/plugins/Common.js" type="text/javascript"></script>        
    <script src="/owner-web/js/plugins/jquery.form.js" type="text/javascript"></script>     
    <script src="/owner-web/js/plugins/jquery.validate.js" type="text/javascript"></script>     
    <script src="/owner-web/js/datepicker_lang_US.js" type="text/javascript"></script>        
    <script src="/owner-web/js/plugins/jquery.datepicker.js" type="text/javascript"></script>     
    <script src="/owner-web/js/plugins/jquery.dropdown.js" type="text/javascript"></script>     
    <script src="/owner-web/js/plugins/jquery.colorselect.js" type="text/javascript"></script>    
     
    <script type="text/javascript">
        if (!DateAdd || typeof (DateDiff) != "function") {
            var DateAdd = function(interval, number, idate) {
                number = parseInt(number);
                var date;
                if (typeof (idate) == "string") {
                    date = idate.split(/\D/);
                    eval("var date = new Date(" + date.join(",") + ")");
                }
                if (typeof (idate) == "object") {
                    date = new Date(idate.toString());
                }
                switch (interval) {
                    case "y": date.setFullYear(date.getFullYear() + number); break;
                    case "m": date.setMonth(date.getMonth() + number); break;
                    case "d": date.setDate(date.getDate() + number); break;
                    case "w": date.setDate(date.getDate() + 7 * number); break;
                    case "h": date.setHours(date.getHours() + number); break;
                    case "n": date.setMinutes(date.getMinutes() + number); break;
                    case "s": date.setSeconds(date.getSeconds() + number); break;
                    case "l": date.setMilliseconds(date.getMilliseconds() + number); break;
                }
                return date;
            }
        }
        function getHM(date)
        {
             var hour =date.getHours();
             var minute= date.getMinutes();
             var ret= (hour>9?hour:"0"+hour)+":"+(minute>9?minute:"0"+minute) ;
             return ret;
        }
        
        function selectField(name) {
        	$("#entityName").val(name);	
        }
        
        $(document).ready(function() {
            //debugger;
            var DATA_FEED_URL = "/owner-web/owner/calendar/datafeed/";
            var arrT = [];
            var tt = "{0}:{1}";
            for (var i = 0; i < 24; i++) {
                arrT.push({ text: StrFormat(tt, [i >= 10 ? i : "0" + i, "00"]) }, { text: StrFormat(tt, [i >= 10 ? i : "0" + i, "30"]) });
            }
            $("#timezone").val(new Date().getTimezoneOffset()/60 * -1);
            $("#stparttime").dropdown({
                dropheight: 200,
                dropwidth:60,
                selectedchange: function() { },
                items: arrT
            });
            $("#etparttime").dropdown({
                dropheight: 200,
                dropwidth:60,
                selectedchange: function() { },
                items: arrT
            });
            $("#Savebtn").click(function() { $("#fmEdit").submit(); });
            $("#Closebtn").click(function() { CloseModelWindow(); });
            $("#Deletebtn").click(function() {
                 if (confirm("Are you sure to remove this event")) {  
                    var param = [{ "name": "calendarId", value: $("#id").val()}];                
                    $.post(DATA_FEED_URL + "remove",
                        param,
                        function(data){
                              if (data.IsSuccess) {
                                    alert(data.Msg); 
                                    CloseModelWindow(null,true);                            
                                }
                                else {
                                    alert("Error occurs.\r\n" + data.Msg);
                                }
                        }
                    ,"json");
                }
            });
            
           $("#stpartdate,#etpartdate").datepicker({ picker: "<button class='calpick'></button>"});    
            //to define parameters of ajaxform
            var options = {
                beforeSubmit: function() {
                    return true;
                },
                dataType: "json",
                success: function(data) {
                    alert(data.Msg);
                    if (data.IsSuccess) {
                        CloseModelWindow(null,true);  
                    }
                }
            };
            $.validator.addMethod("date", function(value, element) {                             
                var arrs = value.split(i18n.datepicker.dateformat.separator);
                var year = arrs[i18n.datepicker.dateformat.year_index];
                var month = arrs[i18n.datepicker.dateformat.month_index];
                var day = arrs[i18n.datepicker.dateformat.day_index];
                var standvalue = [year,month,day].join("-");
                return this.optional(element) || /^(?:(?:1[6-9]|[2-9]\d)?\d{2}[\/\-\.](?:0?[1,3-9]|1[0-2])[\/\-\.](?:29|30))(?: (?:0?\d|1\d|2[0-3])\:(?:0?\d|[1-5]\d)\:(?:0?\d|[1-5]\d)(?: \d{1,3})?)?$|^(?:(?:1[6-9]|[2-9]\d)?\d{2}[\/\-\.](?:0?[1,3,5,7,8]|1[02])[\/\-\.]31)(?: (?:0?\d|1\d|2[0-3])\:(?:0?\d|[1-5]\d)\:(?:0?\d|[1-5]\d)(?: \d{1,3})?)?$|^(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])[\/\-\.]0?2[\/\-\.]29)(?: (?:0?\d|1\d|2[0-3])\:(?:0?\d|[1-5]\d)\:(?:0?\d|[1-5]\d)(?: \d{1,3})?)?$|^(?:(?:16|[2468][048]|[3579][26])00[\/\-\.]0?2[\/\-\.]29)(?: (?:0?\d|1\d|2[0-3])\:(?:0?\d|[1-5]\d)\:(?:0?\d|[1-5]\d)(?: \d{1,3})?)?$|^(?:(?:1[6-9]|[2-9]\d)?\d{2}[\/\-\.](?:0?[1-9]|1[0-2])[\/\-\.](?:0?[1-9]|1\d|2[0-8]))(?: (?:0?\d|1\d|2[0-3])\:(?:0?\d|[1-5]\d)\:(?:0?\d|[1-5]\d)(?:\d{1,3})?)?$/.test(standvalue);
            }, "Invalid date format");
            $.validator.addMethod("time", function(value, element) {
                return this.optional(element) || /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/.test(value);
            }, "Invalid time format");
            $.validator.addMethod("safe", function(value, element) {
                return this.optional(element) || /^[^$\<\>]+$/.test(value);
            }, "$<> not allowed");
            $("#fmEdit").validate({
                submitHandler: function(form) { $("#fmEdit").ajaxSubmit(options); },
                errorElement: "div",
                errorClass: "cusErrorPanel",
                errorPlacement: function(error, element) {
                    showerror(error, element);
                }
            });
            function showerror(error, target) {
                var pos = target.position();
                var height = target.height();
                var newpos = { left: pos.left, top: pos.top + height + 2 }
                var form = $("#fmEdit");             
                error.appendTo(form).css(newpos);
            }
        });
    </script>      
    <style type="text/css">     
    .calpick     {        
        width:16px;   
        height:16px;     
        border:none;        
        cursor:pointer;        
        background:url("/owner-web/css/images/calendar/cal.gif") no-repeat center 2px;        
        margin-left:-22px;    
    }      
    </style>
  </head>
  <body>    
    <div>      
      <div class="toolBotton">           
        <a id="Savebtn" class="imgbtn" href="javascript:void(0);">                
          <span class="Save"  title="Save the calendar">Guardar(<u>G</u>)
          </span>          
        </a>                           
        <c:if test="${not empty event}">
        <input type="hidden" id="id" value="${event.id}" />
        <a id="Deletebtn" class="imgbtn" href="javascript:void(0);">                    
          <span class="Delete" title="Cancel the calendar">Eliminar(<u>E</u>)
          </span>                
        </a>             
        </c:if>            
        <a id="Closebtn" class="imgbtn" href="javascript:void(0);">                
          <span class="Close" title="Close the window" >Cerrar
          </span>           
        </a>        
      </div>                  
      <div style="clear: both">         
      </div>        
      <div class="infocontainer">            
      	<c:if test="${not empty event}">
        <form action="/owner-web/owner/calendar/datafeed/adddetails?id=${event.id}" class="fform" id="fmEdit" method="post">                 
          <label>                    
            <span>Nombre del Jugador:</span>                    
            <input MaxLength="200" class="required safe" id="Subject" name="Subject" style="width:85%;" type="text" value="${event.subject}" />                     
          </label>                 
          <label>                    
            <span>Fecha y hora:</span>                    
            <div>  
            <c:set var="sarr" value="${fn:split(event.startTime, ' ')}" />
            <c:set var="earr" value="${fn:split(event.endTime, ' ')}" />
              <input MaxLength="10" class="required date" id="stpartdate" name="stpartdate" style="padding-left:2px;width:90px;" type="text" value="${sarr[0]}" />                       
              Desde
              <input MaxLength="5" class="required time" id="stparttime" name="stparttime" style="width:40px;" type="text" value="${sarr[1]}" />Hasta                      
              <input MaxLength="50" class="required time" id="etparttime" name="etparttime" style="width:40px;" type="text" value="${earr[1]}" />                                            
            </div>                
          </label>  
           <label>
          	Cancha: 
           	<c:if test="${not empty event.entityName}">
          		<input type="hidden" id="entityName" name="entityName" value="${event.entityName}"></input>
          	</c:if>
          	<select name="entity">
              <c:forEach var="field" items="${fields}">
              	<c:if test="${field.id eq event.entity}">
	              <option onclick="selectField('${field.name}')" selected="selected"  value="${field.id}">${field.name}</option>
              	</c:if>
              	<c:if test="${not (field.id eq event.entity)}">
	              <option onclick="selectField('${field.name}')" value="${field.id}">${field.name}</option>
              	</c:if>
           	  </c:forEach>
             </select>
          </label>                 
        </form>         
        </c:if>
        <c:if test="${empty event}">
        <form action="/owner-web/owner/calendar/datafeed/adddetails" class="fform" id="fmEdit" method="post">                 
          <label>                    
            <span>Nombre del jugador:</span>                    
            <input MaxLength="200" class="required safe" id="Subject" name="Subject" style="width:85%;" type="text" value="" />                     
          </label>                 
          <label>                    
            <span>Fecha y hora</span>                    
            <div>  
            <c:set var="sarr" value="${fn:split(event.startTime, ' ')}" />
            <c:set var="earr" value="${fn:split(event.endTime, ' ')}" />
              <input MaxLength="10" class="required date" id="stpartdate" name="stpartdate" style="padding-left:2px;width:90px;" type="text" value="${sarr[0]}" />                       
            	Desde
              <input MaxLength="5" class="required time" id="stparttime" name="stparttime" style="width:40px;" type="text" value="${sarr[1]}" />Hasta                       
              <input MaxLength="50" class="required time" id="etparttime" name="etparttime" style="width:40px;" type="text" value="${earr[1]}" />                                            
            </div>                
          </label>   
          <label>
          	Cancha: 
          	<input type="hidden" id="entityName" name="entityName" value="${fields[0].name}"></input>
          	<select name="entity">
              <c:forEach var="field" items="${fields}">
	              <option onclick="selectField('${field.name}')" value="${field.id}">${field.name}</option>
           	  </c:forEach>
             </select>
          </label>              
        </form>         
        </c:if>
      </div>         
    </div>
  </body>
</html>